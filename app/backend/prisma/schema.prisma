generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PriceLevel {
  ONE
  TWO
  THREE
  FOUR
}

enum Weekday {
  MON 
  TUE 
  WED 
  THU 
  FRI 
  SAT 
  SUN
}

enum ActivityType {
  REVIEWED
  SAVED
  CHECKED_IN
  CREATED_LIST
}


model User {
  id              Int      @id @default(autoincrement())
  firebaseUid     String   @unique
  username        String?  @unique // Mantido como @handle
  email           String?  @unique
  avatarUrl       String?
  createdAt       DateTime @default(now())

  // Sistema de Gamificação "Noma"
  nomaLevel       Int @default(1)
  nomaCurrentXp   Int @default(0)
  nomaNextLevelXp Int @default(100) // XP para o próximo nível

  // Relações
  reviews         Review[]
  lists           List[]
  savedPlaces     SavedPlace[]
  favoritePlaces  FavoritePlace[]
  activities      Activity[] // Relação com o novo feed de atividades
  followers       Follow[]   @relation("Followers")
  following       Follow[]   @relation("Following")
}

model Place {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  address      String
  imageUrl     String? // Imagem principal/capa
  siteUrl      String?
  phone        String?
  latitude     Float
  longitude    Float
  priceInfo    String?  // Ex: "R$50 - R$80 por pessoa"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relações
  category     Category         @relation(fields: [categoryId], references: [id])
  categoryId   Int
  reviews      Review[]
  savedPlaces  SavedPlace[]
  favoritePlaces FavoritePlace[]
  listItems    ListItem[]
  photos       Photo[]          // Galeria de fotos de clientes
  tags         Tag[]            
  openingHours OpeningHourRule[] // Novo modelo de horário de funcionamento
  events       Event[]          // Relação com o novo modelo de eventos
  activities   Activity[]
}

model Review {
  id                Int      @id @default(autoincrement())
  generalRating     Int
  foodRating        Int
  serviceRating     Int
  environmentRating Int
  comment           String?
  pricePaid         Decimal? // Renomeado de 'price' para clareza
  numberOfPeople    Int?     // Adicionado
  createdAt         DateTime @default(now())

  // Relações
  user              User     @relation(fields: [userId], references: [id])
  userId            Int
  place             Place    @relation(fields: [placeId], references: [id])
  placeId           Int
  activity          Activity? // Link para o evento de feed
}

model Category {
  id       Int     @id @default(autoincrement())
  name     String  @unique
  imageUrl String? // Adicionado para a tela de Busca

  // Relações
  places   Place[]
}

model List {
  id          Int        @id @default(autoincrement())
  name        String
  description String?
  imageUrl    String?    // Adicionado para o carrossel do perfil
  isRanking   Boolean   @default(false) // Indica se a lista é um ranking (ordem importa)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relações
  user        User       @relation(fields: [userId], references: [id])
  userId      Int
  items       ListItem[]
  activities  Activity[]

  @@unique([userId, name])
}

model Tag {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  places Place[] 
}

// --- MODELOS REESTRUTURADOS E NOVOS ---

// Modelo para Horário de Funcionamento (Muito mais flexível)
model OpeningHourRule {
  id        Int     @id @default(autoincrement())
  dayOfWeek Weekday // Seg, Ter, Qua...
  openTime  String  // Ex: "18:00"
  closeTime String  // Ex: "00:00"

  // Relação
  place     Place   @relation(fields: [placeId], references: [id], onDelete: Cascade)
  placeId   Int
}

// Novo: Modelo para o Feed de Atividades de Amigos
model Activity {
  id        Int          @id @default(autoincrement())
  type      ActivityType // REVIEWED, SAVED, etc.
  createdAt DateTime     @default(now())

  // Relações (quem fez a ação e sobre o que)
  user      User         @relation(fields: [userId], references: [id])
  userId    Int
  place     Place?       @relation(fields: [placeId], references: [id])
  placeId   Int?
  review    Review?      @relation(fields: [reviewId], references: [id])
  reviewId  Int?         @unique
  list      List?        @relation(fields: [listId], references: [id])
  listId    Int?
}

// Novo: Modelo para Promoções e Eventos
model Event {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  imageUrl    String
  startDate   DateTime
  endDate     DateTime

  // Relação (onde o evento acontece)
  place       Place    @relation(fields: [placeId], references: [id])
  placeId     Int
}


// --- MODELOS DE RELAÇÃO (Muitos-para-Muitos e outros) ---
// A maioria foi mantida, com pequenas melhorias.

model Photo {
  id        Int      @id @default(autoincrement())
  url       String
  place     Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  placeId   Int
  createdAt DateTime @default(now())
}

model SavedPlace {
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  place     Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  placeId   Int
  createdAt DateTime @default(now())

  @@id([userId, placeId])
}

model Follow {
  follower   User @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  followerId Int
  followed   User @relation("Followers", fields: [followedId], references: [id], onDelete: Cascade)
  followedId Int

  @@id([followerId, followedId])
}

model ListItem {
  list    List     @relation(fields: [listId], references: [id], onDelete: Cascade)
  listId  Int
  place   Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  placeId Int
  order   Int?
  addedAt DateTime @default(now())

  @@id([listId, placeId])
}

model FavoritePlace {
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  place     Place    @relation(fields: [placeId], references: [id], onDelete: Cascade)
  placeId   Int
  createdAt DateTime @default(now())

  @@id([userId, placeId])
}